---
title: DragMap安装和使用
tags: software
---

做生信的，谁还没个“BWA 情结”？
这就像那件穿了十年的旧T恤，虽然领口松了（算法老了），但它舒服、可靠，闭着眼都知道怎么穿。

但是，到了 2025 年，当你面对复杂的肿瘤组织样本，或者需要在几千倍深度的 cfDNA 里找那个 0.1% 的突变时，这位“祖师爷” BWA 可能正在悄悄给你挖坑——尤其是在那些讨厌的**伪基因（Pseudogenes）**区域。

今天我要安利的这款工具——**DragMap**，它不是来和你比“快”的（甚至可能会慢一点），它是来教你什么是**“精准”**的。

它是 Illumina 那台几十万美金的 DRAGEN 硬件的“开源纯软件版”。如果说 BWA 是为了在当年的奔腾处理器上跑得快而设计的，那 DragMap 就是为了在今天的服务器上跑得准而重生的。

---

## 一、 灵魂发问：如果它变慢了，为什么还要换？

先说个反直觉的事实：**在全外显子（WES）分析中，DragMap 很可能比 BWA-MEM 慢，甚至慢 1.5 倍。**

你可能会跳起来：“那我还用个毛线？”
别急，坐下。我们换它的理由只有一个：**为了不被假阳性坑死。**

### 1. 它是 GATK 的“官方指定CP”
Broad Institute 那个浓眉大眼的 GATK 团队，在 4.2 版本后就把[默认比对工具换成了 DragMap](https://gatk.broadinstitute.org/hc/en-us/articles/4410953761563-Introducing-DRAGMAP-the-new-genome-mapper-in-DRAGEN-GATK)。
现在的 DeepVariant 和 DeepSomatic 模型，大多是用 DragMap 的比对结果训练的。你想让 AI 跑得准，就得喂它熟悉的“口味”。

### 2. 专治“真假美猴王”（伪基因）
这是 DragMap 的杀手锏。
BWA 有时候很憨，分不清功能基因和伪基因（序列太像了），容易把 reads 瞎比对，导致你看到一堆假突变。
DragMap 引入了 **Masked Reference** 和更高级的哈希映射策略，它能精准识别这些高同源区域。
**做 Tumor-Only 的朋友注意了：** 用 BWA 你可能需要痛苦地过滤一堆噪音，用 DragMap，这些噪音在比对阶段就消失了。

### 3. MAPQ 的玄学
你会发现 DragMap 输出的 BAM 文件，Mapping Quality (MAPQ) 的分布比 BWA 更合理。这对后续 CNVkit 做拷贝数分析简直是福音，波浪线瞬间变平滑。

---

## 二、 劝退环节：入场门票

在安装前，请检查你的服务器配置。
DragMap 奉行的是“空间换精度”策略，它是个内存巨兽。

* **内存（RAM）需求：**
    * 人类全基因组（hg38）：**至少需要 40GB - 50GB 空闲内存**。
    * **为什么 WES 跑得慢？** 因为它要把这 50GB 的哈希表索引从硬盘读到内存里。对于 WES 这种几分钟能跑完的小数据，光是“加载索引”的时间就够 BWA 跑两轮了。
* **建议：** 如果你的服务器只有 16G 内存……请出门左转继续爱 BWA，我们下辈子有缘再见。

---


## 三、 安装：极其丝滑

到了 2025 年，如果你还在手动编译源码（make -> make install -> 报错 -> 砸键盘），那你太辛苦了。 我们直接用 Conda 或者 Docker。

**方法 A：Conda (懒人首选)**

```bash
# 建议先建个独立环境，防止版本打架
conda create -n dragmap_env
conda activate dragmap_env

# 一行命令搞定
conda install -c bioconda dragmap
```

注：安装完后，二进制程序的名字通常叫` dragen-os`，别傻乎乎地敲 `dragmap`找不到命令。

**方法 B：Docker (洁癖首选)**

如果你不想污染环境，直接拉取镜像：

```bash
docker pull gambalab/dragmap:latest
```

## 四、 建立索引：一次痛苦，终身受益

这是最耗资源的一步。DragMap 的索引不是几个小文件，而是一个目录。

准备工作： 下载好你的 hg38.fa (别忘了顺手下载 GTF 如果需要的话，但比对只需要 fasta)。

```bash
# 创建一个存放索引的文件夹
mkdir -p /data/ref/dragmap_hg38_index

# 开始构建 (这步很吃内存，确保持有 sudo 权限或服务器够劲)
dragen-os \
  --build-hash-table true \
  --ht-reference /data/ref/hg38.fa \
  --output-directory /data/ref/dragmap_hg38_index \
  --ht-num-threads 32
```

等待时间：大概 20-40 分钟（取决于你的磁盘读写速度）。生成的索引文件夹大概有 60GB+，请确保磁盘空间充足。


## 五、 实战：让子弹飞一会儿

索引建好了，现在让我们来体验一下什么是“推背感”。

假设你有两个测序文件：`tumor_R1.fq.gz` 和`tumor_R2.fq.gz`。

```bash
dragen-os \
  -r /data/ref/dragmap_hg38_index \
  -1 tumor_R1.fq.gz \
  -2 tumor_R2.fq.gz \
  --num-threads 24 \
  --RGID "Tumor_Sample_01" \
  --RGSM "Tumor_Sample_01" \
  | samtools sort -@ 8 -o tumor_sorted.bam -
```

## 六、 结果对比与总结

跑完之后，你会发现：

1. 时间： WGS 可能持平，但 WES 确实比 BWA 慢了。别慌，这是为了精度付出的代价。

2. 结果： 去看看那些著名的“坑”位点（比如 PMS2, KMT2D 等伪基因干扰区），你会发现 DragMap 的比对干净得让人想哭。

3. 心情： 睡得更踏实了。

--------------

（内容由AI生成，请仔细甄别！）
